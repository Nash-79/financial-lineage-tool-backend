version: '3.8'

# Production overrides for docker-compose.local.yml
# Usage: docker compose -f docker-compose.local.yml -f docker-compose.prod.yml up

services:
  qdrant:
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '4.0'
        reservations:
          memory: 512M
          cpus: '1.0'
    restart: always

  redis:
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.25'
    restart: always
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru

  api:
    environment:
      # Production environment variables
      - USE_LLAMAINDEX=true
      - LOG_LEVEL=INFO
      - WORKERS=4
    volumes:
      # Remove :ro to allow hot-reload in development
      - ./src:/app/src
      - ./config:/app/config
      - ./data:/app/data
      - ./logs:/app/logs
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '4.0'
        reservations:
          memory: 1G
          cpus: '2.0'
    restart: always
    stop_grace_period: 60s
    healthcheck:
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    # Production command with more workers
    command: uvicorn src.api.main_local:app --host 0.0.0.0 --port 8000 --workers 4

  jupyter:
    # Disable Jupyter in production
    profiles:
      - dev
