# Qdrant Vector Database - Setup Complete

## Status: Qdrant Successfully Running

Qdrant vector database is now running natively on Windows for semantic search and embeddings storage.

### Quick Status Check

```bash
# Check if Qdrant is running
curl http://localhost:6333/collections

# View collections
curl http://localhost:6333/collections | python -m json.tool

# Check Qdrant dashboard (if web UI is available)
# Open: http://localhost:6333/dashboard
```

---

## Installation Summary

### What Was Installed

- **Qdrant Version**: 1.16.2
- **Installation Method**: Native Windows binary (qdrant.exe)
- **Location**: `financial-lineage-tool/qdrant/qdrant.exe`
- **Storage**: `financial-lineage-tool/qdrant/storage/`

### Services Configuration

**Qdrant is running on:**
- REST API: http://localhost:6333
- gRPC API: http://localhost:6334

**Current Collections:**
- `code_chunks` - Created by the API for storing code embeddings

---

## How to Start/Stop Qdrant

### Start Qdrant

```bash
cd financial-lineage-tool/qdrant
./qdrant.exe
```

Or run in background:
```bash
cd financial-lineage-tool/qdrant
start /B qdrant.exe > qdrant.log 2>&1
```

### Stop Qdrant

```bash
# Find the process
tasklist | findstr qdrant

# Kill by PID
taskkill /F /PID <PID>
```

Or:
```bash
# Kill all qdrant processes
taskkill /F /IM qdrant.exe
```

### Check if Running

```bash
# Check port 6333
netstat -ano | findstr :6333

# Test API
curl http://localhost:6333/collections
```

---

## Using Qdrant with the API

### Environment Variables

Already configured in `.env`:
```bash
QDRANT_HOST=localhost
QDRANT_PORT=6333
```

### API Integration

The Financial Lineage Tool API automatically:
1. Connects to Qdrant on startup
2. Creates the `code_chunks` collection (768-dimensional vectors)
3. Stores embeddings generated by Ollama (nomic-embed-text model)
4. Enables semantic search for code and documentation

### Test Connection

```bash
# Run the test script
cd financial-lineage-tool
python test_qdrant.py
```

Expected output:
```
[+] Successfully connected to Qdrant!
[+] Created collection 'test_embeddings'
[+] Inserted 3 test vectors
[+] Found 2 results
[+] All Qdrant tests passed!
```

---

## Collections

### code_chunks (Created by API)

**Purpose**: Store embeddings for semantic search across code and documentation

**Configuration:**
- Vector size: 768 (matches nomic-embed-text output)
- Distance metric: Cosine
- Indexing: HNSW (fast approximate nearest neighbor search)

**Usage:**
```python
from qdrant_client import QdrantClient

client = QdrantClient(host="localhost", port=6333)

# Search for similar code
results = client.query_points(
    collection_name="code_chunks",
    query=[...],  # 768-dim embedding vector
    limit=5
)
```

---

## API Endpoints Using Qdrant

### Semantic Search

```bash
# Search via natural language query
curl -X POST http://localhost:8000/api/v1/lineage/query \
  -H "Content-Type: application/json" \
  -d '{"query": "customer tables with email addresses"}'
```

### Ingest with Embeddings

```bash
# Upload SQL file - automatically generates embeddings
curl -X POST http://localhost:8000/api/v1/ingest \
  -F "file=@schema.sql" \
  -F "source_type=sql"
```

---

## Docker Compose (Alternative)

If you prefer Docker, Qdrant is also configured in `docker-compose.local.yml`:

```bash
# Start Qdrant only
docker compose -f docker-compose.local.yml up -d qdrant

# Stop Qdrant
docker compose -f docker-compose.local.yml down qdrant
```

**Note**: Gremlin Server has been removed from docker-compose since we're using Neo4j.

---

## Monitoring

### View Qdrant Logs

If running in background:
```bash
tail -f financial-lineage-tool/qdrant/qdrant.log
```

### Check Collection Stats

```bash
curl http://localhost:6333/collections/code_chunks | python -m json.tool
```

Example output:
```json
{
  "result": {
    "points_count": 150,
    "vectors_count": 150,
    "indexed_vectors_count": 150,
    "status": "green"
  }
}
```

---

## Troubleshooting

### Qdrant Not Starting

**Error**: Port 6333 already in use
```bash
# Find what's using the port
netstat -ano | findstr :6333

# Kill the process
taskkill /F /PID <PID>
```

**Error**: Missing DLL files
- Make sure you have Visual C++ Redistributable installed
- Download from: https://aka.ms/vs/17/release/vc_redist.x64.exe

### API Can't Connect to Qdrant

1. Check if Qdrant is running:
```bash
curl http://localhost:6333/collections
```

2. Verify environment variables in `.env`:
```bash
QDRANT_HOST=localhost
QDRANT_PORT=6333
```

3. Restart the API:
```bash
cd financial-lineage-tool
python src/api/main_local.py
```

### Collection Not Found

If the API shows "Collection may already exist" error:
```bash
# Delete and recreate the collection
curl -X DELETE http://localhost:6333/collections/code_chunks

# Restart the API - it will recreate the collection
```

---

## Advanced Configuration

### Custom Configuration File

Create `financial-lineage-tool/qdrant/config/config.yaml`:

```yaml
service:
  grpc_port: 6334
  http_port: 6333

storage:
  storage_path: ./storage

hnsw_index:
  m: 16
  ef_construct: 100
  full_scan_threshold: 10000
```

Then start with:
```bash
./qdrant.exe --config-path ./config/config.yaml
```

### Backup Collections

```bash
# Snapshot collection
curl -X POST "http://localhost:6333/collections/code_chunks/snapshots"

# List snapshots
curl http://localhost:6333/collections/code_chunks/snapshots
```

---

## Performance Tips

1. **Increase HNSW parameters** for better accuracy (slower indexing):
   - Increase `m` (default: 16) for more connections
   - Increase `ef_construct` (default: 100) for better graph quality

2. **Use batch operations** when inserting many vectors:
   ```python
   client.upsert(collection_name="code_chunks", points=large_batch)
   ```

3. **Monitor memory usage**:
   - Each 768-dim vector uses ~3KB
   - 100K vectors = ~300MB RAM

---

## Resources

- **Qdrant Docs**: https://qdrant.tech/documentation/
- **GitHub**: https://github.com/qdrant/qdrant
- **API Reference**: https://qdrant.tech/documentation/api-reference/
- **Python Client**: https://github.com/qdrant/qdrant-client

---

## Summary

Qdrant is now fully operational and integrated with the Financial Lineage Tool:

- REST API: http://localhost:6333
- gRPC API: http://localhost:6334
- Collection: `code_chunks` (768-dim vectors)
- Embedding Model: nomic-embed-text (via Ollama)
- Storage: Local file-based (./storage/)

The system is ready for semantic search and vector-based lineage queries!
