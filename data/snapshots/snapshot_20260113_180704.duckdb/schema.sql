CREATE TABLE projects(id VARCHAR PRIMARY KEY, "name" VARCHAR NOT NULL, description VARCHAR, created_at TIMESTAMP DEFAULT(current_timestamp), updated_at TIMESTAMP DEFAULT(current_timestamp), context JSON, context_file_path VARCHAR);;
CREATE TABLE schema_version("version" INTEGER PRIMARY KEY, applied_at TIMESTAMP DEFAULT(current_timestamp));;
CREATE TABLE system_logs(log_id VARCHAR PRIMARY KEY, "timestamp" TIMESTAMP DEFAULT(current_timestamp), "level" VARCHAR NOT NULL, "source" VARCHAR NOT NULL, message VARCHAR NOT NULL, context JSON);;
CREATE TABLE upload_settings(id VARCHAR DEFAULT('default') PRIMARY KEY, allowed_extensions VARCHAR NOT NULL, max_file_size_mb INTEGER NOT NULL, updated_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP), updated_by VARCHAR);;
CREATE TABLE project_links(id VARCHAR PRIMARY KEY, source_project_id VARCHAR NOT NULL, target_project_id VARCHAR NOT NULL, link_type VARCHAR NOT NULL, description VARCHAR, created_at TIMESTAMP DEFAULT(current_timestamp), FOREIGN KEY (source_project_id) REFERENCES projects(id), FOREIGN KEY (target_project_id) REFERENCES projects(id));;
CREATE TABLE repositories(id VARCHAR PRIMARY KEY, project_id VARCHAR NOT NULL, "name" VARCHAR NOT NULL, "source" VARCHAR NOT NULL, source_ref VARCHAR, file_count INTEGER DEFAULT(0), node_count INTEGER DEFAULT(0), last_synced TIMESTAMP, created_at TIMESTAMP DEFAULT(current_timestamp), FOREIGN KEY (project_id) REFERENCES projects(id));;
CREATE TABLE runs(id VARCHAR PRIMARY KEY, project_id VARCHAR NOT NULL, "timestamp" VARCHAR NOT NULL, "sequence" INTEGER NOT NULL, "action" VARCHAR NOT NULL, status VARCHAR NOT NULL, created_at TIMESTAMP DEFAULT(current_timestamp), completed_at TIMESTAMP, error_message VARCHAR, FOREIGN KEY (project_id) REFERENCES projects(id));;
CREATE TABLE files(id VARCHAR NOT NULL, project_id VARCHAR NOT NULL, repository_id VARCHAR, run_id VARCHAR NOT NULL, filename VARCHAR NOT NULL, relative_path VARCHAR, file_type VARCHAR, "source" VARCHAR, status VARCHAR, file_path VARCHAR NOT NULL, file_hash VARCHAR NOT NULL, file_size_bytes BIGINT NOT NULL, is_superseded BOOLEAN DEFAULT(CAST('f' AS BOOLEAN)), superseded_by VARCHAR, created_at TIMESTAMP DEFAULT(current_timestamp), processed_at TIMESTAMP, FOREIGN KEY (project_id) REFERENCES projects(id), FOREIGN KEY (run_id) REFERENCES runs(id));;
CREATE TABLE links(id VARCHAR PRIMARY KEY, project_id VARCHAR NOT NULL, source_repo_id VARCHAR NOT NULL, target_repo_id VARCHAR NOT NULL, link_type VARCHAR NOT NULL, description VARCHAR, confidence FLOAT, evidence JSON, created_at TIMESTAMP DEFAULT(current_timestamp), FOREIGN KEY (project_id) REFERENCES projects(id), FOREIGN KEY (source_repo_id) REFERENCES repositories(id), FOREIGN KEY (target_repo_id) REFERENCES repositories(id));;
CREATE MACRO get_next_sequence (proj_id, ts) AS ((SELECT (COALESCE(max("sequence"), 0) + 1) FROM runs WHERE ((project_id = proj_id) AND ("timestamp" = ts))));;
CREATE MACRO find_duplicate_file (proj_id, repo_id, rel_path, fhash) AS TABLE (SELECT id, run_id, file_path FROM files WHERE ((project_id = proj_id) AND ((repository_id = repo_id) OR ((repository_id IS NULL) AND (repo_id IS NULL))) AND (COALESCE(relative_path, filename) = rel_path) AND (file_hash = fhash) AND (is_superseded = CAST('f' AS BOOLEAN))) LIMIT 1);;
CREATE MACRO find_previous_file_version (proj_id, repo_id, rel_path) AS TABLE (SELECT id, run_id, file_hash FROM files WHERE ((project_id = proj_id) AND ((repository_id = repo_id) OR ((repository_id IS NULL) AND (repo_id IS NULL))) AND (COALESCE(relative_path, filename) = rel_path) AND (is_superseded = CAST('f' AS BOOLEAN))) LIMIT 1);;
CREATE INDEX idx_files_hash ON files(file_hash);;
CREATE UNIQUE INDEX idx_files_id ON files(id);;
CREATE INDEX idx_files_project_filename ON files(project_id, filename);;
CREATE INDEX idx_files_project_hash ON files(project_id, filename, file_hash);;
CREATE INDEX idx_files_project_relative_path ON files(project_id, relative_path);;
CREATE INDEX idx_files_repository ON files(repository_id);;
CREATE INDEX idx_files_run ON files(run_id);;
CREATE INDEX idx_files_source ON files("source");;
CREATE INDEX idx_files_status ON files(status);;
CREATE INDEX idx_links_project ON links(project_id);;
CREATE INDEX idx_links_source ON links(source_repo_id);;
CREATE INDEX idx_links_target ON links(target_repo_id);;
CREATE INDEX idx_logs_level ON system_logs("level");;
CREATE INDEX idx_logs_timestamp ON system_logs("timestamp");;
CREATE INDEX idx_project_links_source ON project_links(source_project_id);;
CREATE INDEX idx_project_links_target ON project_links(target_project_id);;
CREATE INDEX idx_repos_project ON repositories(project_id);;
CREATE INDEX idx_runs_project_timestamp ON runs(project_id, "timestamp");;

